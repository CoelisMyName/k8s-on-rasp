# 初始化集群

## 证书配置

证书存放在 /etc/kubernetes/pki

https://kubernetes.io/docs/setup/best-practices/certificates/

TODO

## 初始化master

kubeadm init --config kubeadm-init.yaml

如果出现CGROUPS_MEMORY: missing错误，则在/boot/cmdline.txt追加一下内容（不开新一行，与前面原有内容用空格隔开），然后reboot

https://blog.csdn.net/lc9zjx/article/details/111463705

cgroup_enable=memory cgroup_memory=1

初始化kubelet失败，原因是因为containerd配置文件里

/etc/containerd/config.toml

```toml
  [plugins."io.containerd.grpc.v1.cri"]
    sandbox_image = "registry.k8s.io/pause:3.6"
```

修改为如下即可

```toml
  [plugins."io.containerd.grpc.v1.cri"]
    sandbox_image = "registry.aliyuncs.com/google_containers/pause:3.8"
```

看到如下信息即为成功

```
[kubelet-finalize] Updating "/etc/kubernetes/kubelet.conf" to point to a rotatable kubelet client certificate and key
I1202 20:54:35.608854    4894 kubeletfinalize.go:134] [kubelet-finalize] Restarting the kubelet to enable client certificate rotation
[addons] Applied essential addon: CoreDNS
[addons] Applied essential addon: kube-proxy

Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

Alternatively, if you are the root user, you can run:

  export KUBECONFIG=/etc/kubernetes/admin.conf

You should now deploy a pod network to the cluster.
Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can join any number of worker nodes by running the following on each as root:

kubeadm join 192.168.1.5:6443 --token abcdef.0123456789abcdef \
        --discovery-token-ca-cert-hash sha256:e234e51665598c056c54c9604cb3872f71a226f29817d0932359b4ea5d0e08e1
```

这时候调用命令kubectl get pod -n kube-system

```
NAME                                    READY   STATUS    RESTARTS   AGE
coredns-c676cc86f-8pzdv                 0/1     Pending   0          173m
coredns-c676cc86f-trvlr                 0/1     Pending   0          173m
etcd-rasp-worker-1                      1/1     Running   1          173m
kube-apiserver-rasp-worker-1            1/1     Running   1          173m
kube-controller-manager-rasp-worker-1   1/1     Running   1          173m
kube-proxy-666cr                        1/1     Running   0          173m
kube-scheduler-rasp-worker-1            1/1     Running   1          173m
```

k8s组件处于ready状态，那是因为还没有安装网络插件

首先下载下来flannel配置yml文件

```shell
wget https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml
```

然后命令启用flannel kubectl apply -f kube-flannel.yml

这时候看到k8s组件进入运行

```
NAME                                    READY   STATUS    RESTARTS   AGE
coredns-c676cc86f-8pzdv                 0/1     Pending   0          3h5m
coredns-c676cc86f-trvlr                 0/1     Pending   0          3h5m
etcd-rasp-worker-1                      1/1     Running   1          3h5m
kube-apiserver-rasp-worker-1            1/1     Running   1          3h5m
kube-controller-manager-rasp-worker-1   1/1     Running   1          3h5m
kube-proxy-666cr                        1/1     Running   0          3h5m
kube-scheduler-rasp-worker-1            1/1     Running   1          3h5m
```

kubectl describe node rasp-worker-1 获取节点描述信息

发现主节点Taints字段上有东西，pod就不会调度到master上

```
Taints:             node-role.kubernetes.io/control-plane:NoSchedule
                    node.kubernetes.io/not-ready:NoSchedule
```

去除Taints字段

kubectl taint nodes --all node-role.kubernetes.io/control-plane-

末尾减号就是去除字段